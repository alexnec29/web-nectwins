name: Workout App Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ” Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ“ Create .env file
      run: |
        echo "DB_HOST=db" >> .env
        echo "DB_PORT=5432" >> .env
        echo "DB_NAME=wow_db" >> .env
        echo "DB_USER=root" >> .env
        echo "DB_PASSWORD=root" >> .env

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: âš™ï¸ Install Docker Compose Plugin
      run: |
        mkdir -p ~/.docker/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.22.0/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
        chmod +x ~/.docker/cli-plugins/docker-compose

    - name: ğŸš€ Build and run containers
      run: docker compose up --build -d

    - name: ğŸ’¤ Wait for containers
      run: sleep 15
    
    - name: âœ… Check app responds HTTP 200 or 302
      run: |
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
        echo "Status: $STATUS"
        if [[ "$STATUS" -ne 200 && "$STATUS" -ne 302 ]]; then
          echo "âŒ Eroare: Cod HTTP neaÈ™teptat"
          exit 1
        fi

    - name: ğŸ§¹ Cleanup
      run: docker compose down
